<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 3.9.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.1"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.1"><link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222"><link rel="alternate" href="/atom.xml" title="哼着自己旳小调调" type="application/atom+xml"><link rel="stylesheet" href="/css/main.css?v=7.4.1"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"7.4.1",exturl:!1,sidebar:{position:"left",display:"post",offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,b2t:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"我们没有找到任何搜索结果: ${query}",hits_stats:"找到约${hits}条结果（用时${time}ms）"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"./public/search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},translation:{copy_button:"复制",copy_success:"复制成功",copy_failure:"复制失败"},sidebarPadding:40}</script><meta name="description" content="MYSQL定时备份任务shell脚本备份的必要性 每个公司的业务都是基于数据进行的，数据的存储基本都是数据库 保证了数据的安全，稳定，也就可以做到防范于未然。 ##冷备和热备"><meta name="keywords" content="MYSQL定时备份任务shell脚本"><meta property="og:type" content="article"><meta property="og:title" content="MYSQL定时备份任务shell脚本"><meta property="og:url" content="https://cy-blogs.cn/Mysql定时备份shell脚本/index.html"><meta property="og:site_name" content="哼着自己旳小调调"><meta property="og:description" content="MYSQL定时备份任务shell脚本备份的必要性 每个公司的业务都是基于数据进行的，数据的存储基本都是数据库 保证了数据的安全，稳定，也就可以做到防范于未然。 ##冷备和热备"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2019-12-23T11:43:21.563Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="MYSQL定时备份任务shell脚本"><meta name="twitter:description" content="MYSQL定时备份任务shell脚本备份的必要性 每个公司的业务都是基于数据进行的，数据的存储基本都是数据库 保证了数据的安全，稳定，也就可以做到防范于未然。 ##冷备和热备"><link rel="canonical" href="https://cy-blogs.cn/Mysql定时备份shell脚本/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,isPage:!1,isArchive:!1}</script><title>MYSQL定时备份任务shell脚本 | 哼着自己旳小调调</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">哼着自己旳小调调</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Happy hum their own small tune</p></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-commonweal"><a href="/404.html/" rel="section"><i class="fa fa-fw fa-heartbeat"></i> 公益 404</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://cy-blogs.cn/Mysql定时备份shell脚本/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="哼着自己旳小调调"><meta itemprop="description" content=""><meta itemprop="image" content="/images/author.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="哼着自己旳小调调"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">MYSQL定时备份任务shell脚本</h1><div class="post-meta"><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">3.3k字</span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="MYSQL定时备份任务shell脚本"><a href="#MYSQL定时备份任务shell脚本" class="headerlink" title="MYSQL定时备份任务shell脚本"></a>MYSQL定时备份任务shell脚本</h1><h2 id="备份的必要性"><a href="#备份的必要性" class="headerlink" title="备份的必要性"></a>备份的必要性</h2><ul><li>每个公司的业务都是基于数据进行的，数据的存储基本都是数据库</li><li>保证了数据的安全，稳定，也就可以做到防范于未然。</li></ul><p>##冷备和热备</p><a id="more"></a><ul><li>冷备份：<ul><li>冷备份，off，快，时间点上恢复</li><li>冷备份发生在数据库已经正常关闭的情况下，当正常关闭时会提供给我们一个完整的数据库，冷备份是将关键性文件拷贝的另外位置的一种说法，对于备份数据库信息而言，冷备份是最快和最安全的方法。</li><li>冷备份的优点：<ul><li>低度维护，安全</li><li>容易归档，拷贝文件</li><li>速度快</li><li>恢复简单</li></ul></li><li>冷备份的缺点：<ul><li>不能按表或按用户恢复</li><li>若磁盘空间有限，只能拷贝到磁带等其他外部存储设备上，速度会很慢。</li><li>恢复限制，在备份期间，数据库不能做写入操作。</li></ul></li></ul></li><li>热备份：<ul><li>在数据库运行时，直接进行备份，对运行的数据库没有影响。</li><li>热备份的优点：<ul><li>可在表空间或数据文件级备份，备份时间段。</li><li>灵活，备份时不影响数据库的使用。</li><li>秒级恢复，能够恢复到某一时间点上。</li></ul></li><li>热备份的缺点：<ul><li>严谨性，尽量不要出错，否则后果很严重。</li><li>维护困难</li></ul></li></ul></li></ul><h2 id="MYSQL备份数据的几种方式"><a href="#MYSQL备份数据的几种方式" class="headerlink" title="MYSQL备份数据的几种方式##"></a>MYSQL备份数据的几种方式##</h2><p>###into outfile</p><ul><li><p>利用<code>select into outfile +指定的路径</code> 实现指定表数据的备份 备份完的文件是文本文件</p><ul><li><p>在使用<code>select into outfile</code> 使用默认的用户是mysql在操作，使用<code>show variables like &#39;datadir&#39;</code>会显示所属mysql用户的文件件具有一切权限</p></li><li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [exam]&gt; show variables like 'datadir';</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| Variable_name | Value           |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| datadir       | /var/lib/mysql/ |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>指定路径可以直接放在mysql所属的文件夹下</p></li><li><p>如果指定文件备份位置，会报错<code>ERROR 1 (HY000): Can&#39;t create/write to file &#39;/data/test.txt&#39; (Errcode: 13)</code> 这是代表mysql没有文件目录的操作权限。</p><ul><li>解决办法<ul><li>直接更改文件目录的所属用户为mysql让mysql拥有一切权限，<code>clown mysql:mysql +指定文件夹的路径</code></li><li>修改文件夹其它用户可以有写的权限。(不建议)</li><li>先备份至mysql所属文件夹内 进行mv</li></ul></li></ul></li><li><p>可以使用<code>load data infile +备份完数据的路径 into table +表名</code> 进行恢复。</p></li></ul></li></ul><h3 id="mysqldump"><a href="#mysqldump" class="headerlink" title="mysqldump##"></a>mysqldump##</h3><ul><li><p>mysqldump 常用来做温备 （所以需要先对备份的数据施加锁，只能读不能写）本质上就是将指定数据库中的数据已sql语句的方式输出 使用重定向到指定的文件</p></li><li><p>施加读锁的方式：</p><ul><li>flush tables with read lock 施加锁，表示把位于内存上的表统统都同步到磁盘上，然后去施加读锁。</li><li>unlock tables 释放锁。</li></ul></li><li><p>全量备份</p><ul><li><p>使用mysqldump工具进行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ax mysql]# mysqldump -uroot -pxieyang --single-transaction --master-data=2 --databases 表名 &gt;/data/mysql/a1_`date +%F`.sql</span><br></pre></td></tr></table></figure><ul><li>–single-transaction 通过在一个事务中导出所有表从而创建一个一致性的快照，（只支持innodb，myisam不支持事务），从而有效的保证了dump文件，即正确的表内容和二进制日志位置。</li><li>–master-data=2 选项开启式默认会打开lock-all-tables 一个是加锁，一个是获取log信息 =1和=2的在于log信息前者不注释，后者注释。</li><li>lock-all-tables 在dump执行的时候会在表上加上读锁，保证数据一致性，innodb不需加上此参数，而使用 –single-tansaction</li><li>–all-databases 导出所有的数据库 也可以指定表名</li></ul></li><li><p>恢复</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ax mysql]# mysql -uroot -p &lt; 备份文件路径/备份文件名</span><br></pre></td></tr></table></figure></li></ul></li><li><p>增量备份</p><ul><li><p>使用mysqlbinlog工具进行，本质上就是指定备份文件的log开始偏移量和结束日志的偏移量</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ax mysql]# mysqlbinlog --start-position=3210 /var/lib/mysql/mysql-bin.000009 &gt; /data/mysql/a1_2019-12-19_17.sql</span><br></pre></td></tr></table></figure><ul><li><p>–start-position=开始的偏移量</p></li><li><p>–stop-position=结束的偏移量</p></li><li><p>可以先使用<code>show master status</code> 来查看日志版本</p></li><li><p>通过find / -name 日志版本名来查找到路径</p></li><li><p>使用<code>mysqlbinlog --start-position=上次同步的结束位置 查询到的路径</code> 来查看需要同步的结束偏移量</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ax mysql]# mysqlbinlog --start-position=0 /var/lib/mysql/mysql-bin.000010</span><br><span class="line">SET TIMESTAMP=1576755138/*!*/;</span><br><span class="line">insert into a1 values (4,'赵六'),(5,'冯七')</span><br><span class="line">/*!*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> at 423</span></span><br><span class="line"><span class="meta">#</span><span class="bash">191219 19:32:18 server id 1  end_log_pos 450 	Xid = 919</span></span><br><span class="line">COMMIT/*!*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> at 450</span></span><br><span class="line"><span class="meta">#</span><span class="bash">191219 19:32:32 server id 1  end_log_pos 531 	Query	thread_id=334	exec_time=0	error_code=0</span></span><br><span class="line">SET TIMESTAMP=1576755152/*!*/;</span><br><span class="line">drop database exam</span><br><span class="line">/*!*/;</span><br><span class="line"><span class="meta">#</span><span class="bash"> at 531</span></span><br><span class="line"><span class="meta">#</span><span class="bash">191219 19:50:53 server id 1  end_log_pos 574 	Rotate to mysql-bin.000011  pos: 4</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"><span class="meta">#</span><span class="bash"> End of <span class="built_in">log</span> file</span></span><br><span class="line">ROLLBACK /* added by mysqlbinlog */;</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</span><br></pre></td></tr></table></figure></li><li><p>其中end_log_pos就是结束的偏移量</p></li><li><p>或者直接使用<code>show master status</code> 中查询出来的偏移量，备份到操作该库的最后一次位置</p></li></ul></li><li><p>恢复，和全量恢复是相同的</p><ul><li>[root@ax mysql]# mysql -uroot -p &lt; 备份文件路径/增量备份名备份文件名</li><li>恢复前先关闭二进制日志 <code>set sql_log_bin=0</code></li><li>滚动日志 <code>flush logs</code></li></ul></li></ul></li></ul><p>###利用lvm快照备份和恢复##</p><ul><li>LVM（Logical Volume Manager）是一个应用于Linux的内核的逻辑卷管理器，是Linux环境下对磁盘进行分区管理的一种机制。相关名词：<ul><li>PV（物理卷）可以是一个磁盘，一个分区。由PE（物理盘区）组成，多个PV可以组成一个VG（卷组）<ul><li>VG（卷组）多个物理卷组成的一个组，卷组不可以直接使用，需要在上面创建LV（逻辑卷）才可以使用。VG上可以创建多个LV。</li><li>PE（物理盘区），默认是4MB,像磁盘的block块</li><li>LV（逻辑卷）是建立在卷组之上的一个可用空间，有物理边界和逻辑边界两种边界。</li></ul></li></ul></li><li>LVM扩展<ul><li><a href="https://www.jb51.net/LINUXjishu/105937.html" target="_blank" rel="noopener">连接</a></li><li>LVM是一种将一个或多个硬盘的分区在逻辑上的集合，相当于一个大硬盘来使用，当空间不够使用时，可以继续将其它硬盘的分区加入其中，这样可以实现一种磁盘空间的动态管理，相对于普通的磁盘分区有很大的灵活性，使用普通的磁盘分区，当一个磁盘的分区空间不够使用的时候，可能就会带来很大的麻烦，使用LVM在一定程度就可以解决普通磁盘分区带来的问题。LVM通常用于装备大量磁盘的系统，但他它同样适于仅有一，两块硬盘的小系统。</li></ul></li></ul><h3 id="Mysql定时备份shell脚本"><a href="#Mysql定时备份shell脚本" class="headerlink" title="Mysql定时备份shell脚本###"></a>Mysql定时备份shell脚本###</h3><ul><li><p>利用的都是mysqldump，利用Crontab设置定时任务，来自动执行备份命令。直接上代码。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 以下配置信息请自己修改</span></span><br><span class="line">mysql_user="root" #MySQL备份用户</span><br><span class="line">mysql_password="password" #MySQL备份用户的密码</span><br><span class="line">mysql_host="localhost"</span><br><span class="line">mysql_port="3306"</span><br><span class="line">mysql_charset="utf8" #MySQL编码</span><br><span class="line">backup_db_arr=("db1" "db2") #要备份的数据库名称，多个用空格分开隔开 如("db1" "db2" "db3")</span><br><span class="line">backup_location=/data/mysql #备份数据存放位置，末尾请不要带"/",此项可以保持默认，程序会自动创建文件夹</span><br><span class="line">expire_backup_delete="ON" #是否开启过期备份删除 ON为开启 OFF为关闭</span><br><span class="line">expire_days=3 #过期时间天数 默认为三天，此项只有在expire_backup_delete开启时有效</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 本行开始以下不需要修改</span></span><br><span class="line">backup_time=`date +%F:%T` #定义备份详细时间</span><br><span class="line">backup_Ymd=`date +%Y-%m-%d` #定义备份目录中的年月日时间</span><br><span class="line">backup_3ago=`date -d '3 days ago' +%Y-%m-%d` #3天之前的日期</span><br><span class="line">backup_dir=$backup_location/$backup_Ymd #备份文件夹全路径</span><br><span class="line">welcome_msg="Welcome to use MySQL backup tools!" #欢迎语</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断MYSQL是否启动,mysql没有启动则备份退出</span></span><br><span class="line">mysql_ps=`ps -ef |grep mysql |wc -l`</span><br><span class="line">mysql_listen=`netstat -an |grep LISTEN |grep $mysql_port|wc -l`</span><br><span class="line">if [ [$mysql_ps == 0] -o [$mysql_listen == 0] ]; then</span><br><span class="line">echo "`date +%F:%T` --ERROR:MySQL is not running! backup stop!"</span><br><span class="line">exit</span><br><span class="line">else</span><br><span class="line">echo "备份时间-- `date +%F:%T`"</span><br><span class="line">echo `date +%F:%T` -- $welcome_msg</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接到mysql数据库，无法连接则备份退出</span></span><br><span class="line">mysql -h$mysql_host -P$mysql_port -u$mysql_user -p$mysql_password &lt;&lt;end</span><br><span class="line">use mysql;</span><br><span class="line">select host,user from user where user='root' and host='localhost';</span><br><span class="line">exit</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">flag=`echo $?`</span><br><span class="line">if [ $flag != "0" ]; then</span><br><span class="line">echo "`date +%F:%T` --ERROR:Can't connect mysql server! backup stop!"</span><br><span class="line">exit</span><br><span class="line">else</span><br><span class="line">echo "`date +%F:%T` --MySQL connect ok! Please wait......"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断有没有定义备份的数据库，如果定义则开始备份，否则退出备份</span></span><br><span class="line">if [ "$backup_db_arr" != "" ];then</span><br><span class="line"><span class="meta">#</span><span class="bash">dbnames=$(cut -d <span class="string">','</span> -f1-5 <span class="variable">$backup_database</span>)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">echo</span> <span class="string">"arr is (<span class="variable">$&#123;backup_db_arr[@]&#125;</span>)"</span></span></span><br><span class="line">for dbname in $&#123;backup_db_arr[@]&#125;</span><br><span class="line">do</span><br><span class="line">echo "`date +%F:%T` --database $dbname backup start..."</span><br><span class="line">`mkdir -p $backup_dir`</span><br><span class="line">`mysqldump -h$mysql_host -P$mysql_port -u$mysql_user -p$mysql_password $dbname --default-character-set=$mysql_charset | gzip &gt; $backup_dir/$dbname-$backup_time.sql.gz`</span><br><span class="line">flag=`echo $?`</span><br><span class="line">if [ $flag == "0" ];then</span><br><span class="line">echo "`date +%F:%T` --database $dbname success backup to $backup_dir/$dbname-$backup_time.sql.gz"</span><br><span class="line">else</span><br><span class="line">echo "`date +%F:%T` --database $dbname backup fail!"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line">else</span><br><span class="line">echo "`date +%F:%T` --ERROR:No database to backup! backup stop"</span><br><span class="line">exit</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果开启了删除过期备份，则进行删除操作</span></span><br><span class="line">if [ "$expire_backup_delete" == "ON" -a "$backup_location" != "" ];then</span><br><span class="line"><span class="meta">#</span><span class="bash">`find <span class="variable">$backup_location</span>/ -<span class="built_in">type</span> d -o -<span class="built_in">type</span> f -ctime +<span class="variable">$expire_days</span> -<span class="built_in">exec</span> rm -rf &#123;&#125; \;`</span></span><br><span class="line">`find $backup_location/ -type d -mtime +$expire_days | xargs rm -rf`</span><br><span class="line">echo "`date +%F:%T` --Expired backup data delete complete!"</span><br><span class="line">fi</span><br><span class="line">echo "`date +%F:%T` --All database backup success! Thank you!"</span><br><span class="line">echo ""</span><br><span class="line">exit</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>在非linux界面下操作，sh脚本中每行都会多个\r，导致linux无法执行脚本。解决办法，使用vim编辑shell脚本文件，执行::set ff=unix。文件即使unix文件了。可以使用::set ff? 查看文件的类型。dos就是在ATOM操作后保存的文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fileformat=unix </span><br><span class="line">fileformat=dos</span><br></pre></td></tr></table></figure></li><li><p>文件的创建默认UGO权限为 -rw-r–r– 代表的这个文件没有执行权限，所以需要给文件增加权限。</p><ul><li><p>文件创建者拥有所有权限，用户组和其他组只有执行权限</p><p><code>chmod 711 备份文件</code></p></li><li><p>r=4 w=2 x=1</p></li></ul></li><li><p>拥有了执行权限后，该shell脚本就可以执行了，可以执行一下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ax auto_backup]# ./Backup.sh </span><br><span class="line">备份时间-- 2019-12-20:17:09:40</span><br><span class="line">2019-12-20:17:09:40 -- Welcome to use MySQL backup tools!</span><br><span class="line">host	user</span><br><span class="line">localhost	root</span><br><span class="line">2019-12-20:17:09:40 --MySQL connect ok! Please wait......</span><br><span class="line">2019-12-20:17:09:40 --database exam backup start...</span><br><span class="line">2019-12-20:17:09:40 --database exam success backup to /data/mysql/2019-12-20/exam-2019-12-20:17:09:40.sql.gz</span><br><span class="line">2019-12-20:17:09:40 --database shiyouyun backup start...</span><br><span class="line">mysqldump: Got error: 1049: "Unknown database 'shiyouyun'" when selecting the database</span><br><span class="line">2019-12-20:17:09:40 --database shiyouyun success backup to /data/mysql/2019-12-20/shiyouyun-2019-12-20:17:09:40.sql.gz</span><br><span class="line">2019-12-20:17:09:40 --Expired backup data delete complete!</span><br><span class="line">2019-12-20:17:09:40 --All database backup success! Thank you!</span><br></pre></td></tr></table></figure></li><li><p>执行成功说明shell没有问题，只剩下写入定时任务了</p></li></ul><h4 id="Crontab"><a href="#Crontab" class="headerlink" title="Crontab####"></a>Crontab####</h4><ul><li><p>linux下使用crontab命令来提交和管理用户需要定时、周期性的执行任务。</p></li><li><p>linux下默认会安装此服务工具，并且会自动启动crond进程，crond进程会每分钟定期检查是否有要执行的任务。如果有要执行的任务，则自动执行该任务。</p></li><li><p>命令语法：</p><ul><li>crontab（选项） （参数）</li><li>选项：<ul><li>-e 编辑该用户的计时设置</li><li>-l 列出该用户的计时器设置</li><li>-r 删除该用户的计时器设置</li><li>-u 用户名称 指定要设定计时器的用户名称</li></ul></li><li>参数：<ul><li>crontab文件 指定包含待执行任务的crontab文件</li></ul></li></ul></li><li><p>直接在/etc/crontab文件中添加shell脚本任务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00 3 * * * root /data/auto_backup/Backup.sh &gt;&gt; /data/mysql/backup.log</span><br></pre></td></tr></table></figure><ul><li>上面代表每天在凌晨3点运行Backup.sh脚本 并将输出重定向追加到backup.log文件中。</li><li>从左往右依次代表<ul><li>分 可取0-59的整数 加/数字 代表每分钟执行多少次</li><li>时 可取0-23的整数</li><li>天 可取1-31的整数 ，必须是指定月份的有效日期</li><li>月 可取1-12的整数，也可写英文简写</li><li>周几 可取1-7的整数，描述周几</li><li>执行的用户 指定用户</li><li>shell脚本的路径</li><li>log日志的路径</li></ul></li></ul></li><li><p>添加完后保存，重启crond服务。一切ok</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>ax mysql]# ls</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>  backup.log</span><br><span class="line">[<span class="symbol">root@</span>ax mysql]# cd <span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>/</span><br><span class="line">[<span class="symbol">root@</span>ax <span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>]# ls</span><br><span class="line">exam<span class="number">-201912201600.</span>sql.gz  exam<span class="number">-201912201613.</span>sql.gz         exam<span class="number">-2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01.</span>sql.gz  shiyouyun<span class="number">-201912201608.</span>sql.gz  shiyouyun<span class="number">-2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">21</span>:<span class="number">01.</span>sql.gz</span><br><span class="line">exam<span class="number">-201912201601.</span>sql.gz  exam<span class="number">-201912201614.</span>sql.gz         exam<span class="number">-2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">32</span>:<span class="number">01.</span>sql.gz  shiyouyun<span class="number">-201912201609.</span>sql.gz  shiyouyun<span class="number">-2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">22</span>:<span class="number">01.</span>sql.gz</span><br><span class="line">[<span class="symbol">root@</span>ax mysql]# cat backup.log </span><br><span class="line">备份时间-- <span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">30</span>:<span class="number">01</span></span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">30</span>:<span class="number">01</span> -- Welcome to use MySQL backup tools!</span><br><span class="line">host	user</span><br><span class="line">localhost	root</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">30</span>:<span class="number">01</span> --MySQL connect ok! Please wait......</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">30</span>:<span class="number">01</span> --database exam backup start...</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">30</span>:<span class="number">01</span> --database exam success backup to /data/mysql/<span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>/exam<span class="number">-2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">30</span>:<span class="number">01.</span>sql.gz</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">30</span>:<span class="number">01</span> --database shiyouyun backup start...</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">30</span>:<span class="number">01</span> --database shiyouyun success backup to /data/mysql/<span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>/shiyouyun<span class="number">-2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">30</span>:<span class="number">01.</span>sql.gz</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">30</span>:<span class="number">01</span> --Expired backup data delete complete!</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">30</span>:<span class="number">01</span> --All database backup success! Thank you!</span><br><span class="line"></span><br><span class="line">备份时间-- <span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01</span></span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01</span> -- Welcome to use MySQL backup tools!</span><br><span class="line">host	user</span><br><span class="line">localhost	root</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01</span> --MySQL connect ok! Please wait......</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01</span> --database exam backup start...</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01</span> --database exam success backup to /data/mysql/<span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>/exam<span class="number">-2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01.</span>sql.gz</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01</span> --database shiyouyun backup start...</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01</span> --database shiyouyun success backup to /data/mysql/<span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>/shiyouyun<span class="number">-2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01.</span>sql.gz</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01</span> --Expired backup data delete complete!</span><br><span class="line"><span class="number">2019</span><span class="number">-12</span><span class="number">-20</span>:<span class="number">16</span>:<span class="number">31</span>:<span class="number">01</span> --All database backup success! Thank you!</span><br></pre></td></tr></table></figure></li></ul></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div id="reward-container"><div>你好我好大家好！</div> <button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';"> 打赏</button><div id="qr" style="display:none"><div style="display:inline-block"> <img src="/images/wechatpay.jpg" alt="哼着自己旳小调调 微信支付"><p>微信支付</p></div><div style="display:inline-block"> <img src="/images/alipay.jpg" alt="哼着自己旳小调调 支付宝"><p>支付宝</p></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 哼着自己旳小调调</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://cy-blogs.cn/Mysql定时备份shell脚本/" title="MYSQL定时备份任务shell脚本">https://cy-blogs.cn/Mysql定时备份shell脚本/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/MYSQL定时备份任务shell脚本/" rel="tag"># MYSQL定时备份任务shell脚本</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/redis持久化/" rel="next" title="Redis 持久化之RDB和AOF"><i class="fa fa-chevron-left"></i> Redis 持久化之RDB和AOF</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></article></div></div></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MYSQL定时备份任务shell脚本"><span class="nav-text">MYSQL定时备份任务shell脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#备份的必要性"><span class="nav-text">备份的必要性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MYSQL备份数据的几种方式"><span class="nav-text">MYSQL备份数据的几种方式##</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mysqldump"><span class="nav-text">mysqldump##</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mysql定时备份shell脚本"><span class="nav-text">Mysql定时备份shell脚本###</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Crontab"><span class="nav-text">Crontab####</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/author.jpg" alt="哼着自己旳小调调"><p class="site-author-name" itemprop="name">哼着自己旳小调调</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">34</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">15</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/CY-xiaobai/" title="GitHub &rarr; https://github.com/CY-xiaobai/" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="/347947872@qq.com" title="E-Mail &rarr; 347947872@qq.com"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://weibo.com" title="Weibo &rarr; https://weibo.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> Weibo</a></span></div><div class="cc-license motion-element" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 大神个人博客</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://lienze.tech/blog/mysql/c813917a.html" title="https://lienze.tech/blog/mysql/c813917a.html" rel="noopener" target="_blank">老渔夫吃虾米</a></li><li class="links-of-blogroll-item"> <a href="https://v3u.cn/l_id_4_p_2" title="https://v3u.cn/l_id_4_p_2" rel="noopener" target="_blank">悦哥</a></li><li class="links-of-blogroll-item"> <a href="https://xiuxiu.tech/" title="https://xiuxiu.tech/" rel="noopener" target="_blank">阳</a></li><li class="links-of-blogroll-item"> <a href="https://www.angle-dream.top/" title="https://www.angle-dream.top/" rel="noopener" target="_blank">梦</a></li><li class="links-of-blogroll-item"> <a href="https://xiaozhuang.tech/" title="https://xiaozhuang.tech/" rel="noopener" target="_blank">壮</a></li><li class="links-of-blogroll-item"> <a href="https://qzloo.cn" title="https://qzloo.cn" rel="noopener" target="_blank">龙</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 豫ICP备19041663号<span itemprop="copyrightYear"></span><span class="with-love" id="animate"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">哼着自己旳小调调</span><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">站点总字数：</span> <span title="post.totalcount">101.9k字</span> <span title="站点总字数">260k</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="true"></script><script src="/lib/anime.min.js?v=3.1.0"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script><script src="/js/schemes/pisces.js?v=7.4.1"></script><script src="/js/next-boot.js?v=7.4.1"></script><script src="/js/local-search.js?v=7.4.1"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/",tagMode:!1})</script></body><script type="text/javascript" src="/js/clicklove.js"></script></html>